




# 导言

- （恐龙书）**Operating System Concepts**
	[[书库/Operating System Concepts by Abraham Silberschatz, Greg Gagne, Peter B. Galvin.pdf]]
	[[操作系统概念.pdf]]
- 前置课程
	- c语言
	- 数据结构
	- 汇编语言
	- 微机原理与系统
- 介于软件和硬件之间
- 成绩组成部分
	- 课堂表现 5%
	- 实验 30%
	- 作业小测 10%
	- 考试 45%


# CS&Von Neumann architecture

- 计算机
	- 可编程的:灵活
		- 提供指令集：程序就是一个指令集序列
	- 不可编程的：强定制，高效

## 五大部件 

1. 运算器：处理算术和逻辑运算，如加、减、乘、除等。

2. 控制器：控制计算机的运行，包括指令的获取、解码和执行。

3. 存储器：存储数据和程序。

4. 输入设备：用于将数据输入计算机，如键盘、鼠标等。

5. 输出设备：用于将计算机处理后的结果输出，如打印机、显示器等。


## What is OS

- 没有一个统一的，适用的定义!

- 单体系统：所有操作系统功能都包含在一个单独的内核中。
- 分层系统：将操作系统分为多个层次，每个层次提供一组相关的功能。
- 微内核系统：只包含最基本的操作系统功能，所有其他功能都作为“服务”运行在微内核之上。
- 客户机/服务器模型：将操作系统划分为客户机和服务器两个部分，在客户机和服务器之间进行通信。


- What OSes do you know 
	- Windows series,Unix Series, macOS, Linux, Android, iOS.
### Role of OS

-  User view

![](http://picturebed.neverwacky.xyz/img/20230306111155.png)

-  System View 
	*补充：*
	1.用户与计算机硬件系统之间的接口（interface）
		- 命令接口
		- 图形用户接口
		- 编程接口
		2.计算机资源的管理者
		3.

### General structure of OS
Lines of OS Source code：以linux为例，以下是一些估计值：

- Linux kernel 5.10.7：约2600万行
- Ubuntu 20.04 LTS：约2.2亿行
- Fedora 33：约3.4亿行
- Debian GNU/Linux 10：约4亿行


 *RTEMS：一种微内核抢占式实时操作系统*

### Design of OS
- **方便性**和**有效性**是操作系统设计的两个基本目标。
	- 方便性是指操作系统应该为用户提供简单、易用、直观、友好的界面，使得用户能够轻松地完成各种任务。
	- 有效性则是指操作系统应该能够高效地管理计算机资源，包括处理器、内存、磁盘等，并保证它们被合理地分配和利用。这样可以确保计算机系统能够在最小的时间内完成任务，提高计算机系统的整体性能和效率。
	- 同时，这两个目标也是相互依存的：方便性可以提高用户对操作系统的接受度，而有效性则可以支持更复杂、更强大的功能。因此，在进行操作系统设计时，需要平衡这两个目标，并优化它们之间的关系，以实现最佳的结果。
## History of OS
- 一块主板
	![](http://picturebed.neverwacky.xyz/img/20230308081048.png)


## Systme boot 

当计算机电源打开或重启以便开始运行时, 它需要运行一个**初始程序**。该初始程序或引导程序 (bootstrap program) 通常很简单, 一般位于计算机的固件 ( firmware), 如只读内存 ( Read-Only Memory, ROM) 或电可擦可编程只读内存 (Electrically Erasable Programmable Read-Only Memory, EEPROM)。它初始化系统的各个组件, 从 CPU 苛存器、设备控制器 到内存内容。引导程序必须知道如何加载操作系统并且开始执行系统。为了完成这一目标, 引导程序必须定位操作**系统内核**并且加到内存。
一旦内核加到内存并执行, 它就开始为系统与用户提供服务。除了内核外, 系统程序 也提供一些服务, 它们在启动时加到内存而成为系统进程 (system process) 或系统后台程序 (system daemon), 其生命周期与内核一样。对于 UNIX, 首个系统进程为 “init”, 它启动许 多其他系统的后台程序。一旦这个阶段完成, 系统就完全启动了, 并且等待事件发生。
事件发生通常通过硬件或软件的**中断**（interrupt）来通知。硬件可以随时通过系统总线 发送信号到 CPU, 以触发中断。软件也可通过执行特别操作即系统调用 (system call)（也称 为监督程序调用 (monitor call)), 以触发中断。
当 $\mathrm{CPU}$ 被中断时, 它停止正在做的事, 并立即转到固定位置再继续执行。该固定位置 通常包含中断服务程序的开始地址。中断服务程序开始执行, 在执行完后, CPU 重新执行 被中断的计算。这一运行的时间表如图 1-3 所示。
![](http://picturebed.neverwacky.xyz/img/20230308081908.png)
Linux系统启动顺序：
	1、加载BIOS的硬件信息与进行自我测试，并依据设置取得第一个可启动的设备；
	2、读取并执行第一个启动设备内MBR的boot loader（就是grub等程序）
	3、依据引导设置加载kernel。kernel会开始检测硬件与加载驱动程序
	4、在硬件驱动成功后，kernel会主动调用init进程，而init会取得run-level信息
	5、init执行/etc/rc.d/rc.sysinit 文件来准备软件执行的操作环境
	6、init执行run-level的各个服务的启动
	7、init执行/etc/rc.d/rc.local文件
	8、init执行终端机模拟程序mingetty来启动login进程，最后等待用户登录

### BIOS（基本输入输出系统）

- MBR（主引导记录）：

## 系统中断

- For handware：设备中断（狭义中断）
	- 键盘输入，鼠标移动
	- 计时器
- 异常：also for handware（广义中断）
	- Trap for debug（比如打断点）
	- Fault（可以修复的）
	- Abort，a serious error（严重错误，无法修复的错误）
	 > -   Fault是一种异常，它是由于程序执行错误或者内存访问错误引起的。Fault通常可以被修复，例如通过换出页面或者加载缺失的代码段。修复后，程序可以从引起Fault的指令重新开始执行。
	 > -   Trap是一种有意识的异常，它是由于程序主动请求内核服务或者进行特权操作而引起的。Trap通常不需要修复，而是直接执行内核控制路径来完成相应的功能。完成后，程序可以从下一条指令继续执行。 
- For software：System Call
	- [系统调用是指运行在用户空间的程序向操作系统内核请求需要更高权限运行的服务](https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8)[1](https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8)[。系统调用提供用户程序与操作系统之间的接口](https://blog.csdn.net/lijiajia81/article/details/8534704)[2](https://blog.csdn.net/lijiajia81/article/details/8534704)[，把应用程序的请求传给内核，调用相应的内核函数完成所需功能](https://baike.baidu.com/item/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/861110)[3](https://baike.baidu.com/item/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/861110)。
### 中断向量表
- 在Linux中，系统调用的中断矢量是0x80。
- 在windows中，系统调用的中断矢量是0x21
The response is from both the web page context and the web search results.

Linux的中断矢量表是一个存储了256个中断向量的内存区域，每个中断向量占用4字节，包含了中断服务程序的入口地址¹。中断向量表的作用是根据中断类型号（0~255）来调用相应的中断处理函数³。

其中重要部分的表格如下：

| 中断类型号 | 中断名称 | 中断描述 |
| :---: | :---: | :---: |
| 0 | 除法错误 | 当除数为0或者商超过寄存器容量时发生 |
| 1 | 调试异常 | 当执行INT 1指令或者设置了TF标志位时发生 |
| 2 | NMI非屏蔽中断 | 当外部设备发出非屏蔽信号时发生 |
| 3 | 断点异常 | 当执行INT 3指令时发生 |
| 4 | 溢出异常 | 当执行INTO指令且OF标志位为1时发生 |
| 5 ~ 31 | 处理器保留异常和陷阱 | 处理器内部使用，不可被用户程序使用或修改 |
| 32 ~ 255 | 用户自定义中断和外部硬件中断 | 可以被用户程序使用或修改，用于实现系统调用或响应外部设备 |

上述表格只是一个简单的示例，其中包含了一些常见的中断号和对应的设备或事件。在实际中，中断矢量表可能会更加复杂，同时还可能包括其他信息，如中断号、优先级、处理函数的参数等。

### 保存上下文
- 使用栈来保存上下文，保存返回地址
- 恢复上下文的顺序应该和保存上下文的顺序一致，即后保存的要先恢复
## I/O structure
>我们关系如何访问到设备
>	- 我们需要知道端口的地址
>我们如何对设备进行编程
>	- 我们需要知道对应的控制字
### I/O的操作
![](http://picturebed.neverwacky.xyz/img/20230308092530.png)


